<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>k8s安装 | 孑文的Blog</title><meta name="author" content="jiewen"><meta name="copyright" content="jiewen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="系统环境   系统 内核 docker ip 主机名 配置    centos7.6 3.10.0-1127.el7.x86_64 18.09 192.168.41.20 master 2核2G   centos7.6 3.10.0-1127.el7.x86_64 18.09 192.168.41.10 node 2核2G   #注意：docker 要安装18.09版本，否则报如下警告：#[WA">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s安装">
<meta property="og:url" content="https://radiant-zi.github.io/2020/12/08/k8s%E7%9A%84%E5%AE%89%E8%A3%85/index.html">
<meta property="og:site_name" content="孑文的Blog">
<meta property="og:description" content="系统环境   系统 内核 docker ip 主机名 配置    centos7.6 3.10.0-1127.el7.x86_64 18.09 192.168.41.20 master 2核2G   centos7.6 3.10.0-1127.el7.x86_64 18.09 192.168.41.10 node 2核2G   #注意：docker 要安装18.09版本，否则报如下警告：#[WA">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208203141264.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center">
<meta property="article:published_time" content="2020-12-08T12:32:10.000Z">
<meta property="article:modified_time" content="2020-12-22T11:31:46.761Z">
<meta property="article:author" content="jiewen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20201208203141264.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center"><link rel="shortcut icon" href="/Radiant-zi/img/3.png"><link rel="canonical" href="https://radiant-zi.github.io/2020/12/08/k8s%E7%9A%84%E5%AE%89%E8%A3%85/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><link rel="stylesheet" href="/Radiant-zi/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/Radiant-zi/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":30,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-22 19:31:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><link rel="stylesheet" href="./css/mycss.css"><link rel="stylesheet" href="./css/background.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/Radiant-zi/img/avatar.gif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/Radiant-zi/archives/"><div class="headline">文章</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/Radiant-zi/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/Radiant-zi/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/Radiant-zi/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/Radiant-zi/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/Radiant-zi/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://img-blog.csdnimg.cn/20201208203141264.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/Radiant-zi/">孑文的Blog</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/Radiant-zi/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/Radiant-zi/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/Radiant-zi/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/Radiant-zi/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">k8s安装</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2020-12-08T12:32:10.000Z" title="undefined 2020-12-08 20:32:10">2020-12-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/Radiant-zi/categories/k8s/">k8s</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><img src="https://img-blog.csdnimg.cn/20201208202135796.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center"></p>
<h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><table>
<thead>
<tr>
<th align="center">系统</th>
<th align="center">内核</th>
<th align="center">docker</th>
<th align="center">ip</th>
<th align="center">主机名</th>
<th align="center">配置</th>
</tr>
</thead>
<tbody><tr>
<td align="center">centos7.6</td>
<td align="center">3.10.0-1127.el7.x86_64</td>
<td align="center">18.09</td>
<td align="center">192.168.41.20</td>
<td align="center">master</td>
<td align="center">2核2G</td>
</tr>
<tr>
<td align="center">centos7.6</td>
<td align="center">3.10.0-1127.el7.x86_64</td>
<td align="center">18.09</td>
<td align="center">192.168.41.10</td>
<td align="center">node</td>
<td align="center">2核2G</td>
</tr>
</tbody></table>
<p>#注意：docker 要安装18.09版本，否则报如下警告：<br>#[WARNING SystemVerification]: this Docker version is not on the list of validated versions: 19.03.5. Latest validated version: 18.09</p>
<h3 id="先参照此博客的错误https-blog-csdn-net-nklinsirui-article-details-80583971"><a href="#先参照此博客的错误https-blog-csdn-net-nklinsirui-article-details-80583971" class="headerlink" title="先参照此博客的错误https://blog.csdn.net/nklinsirui/article/details/80583971"></a>先参照此博客的错误<a target="_blank" rel="noopener" href="https://blog.csdn.net/nklinsirui/article/details/80583971">https://blog.csdn.net/nklinsirui/article/details/80583971</a></h3><h2 id="一、在两节点（master和node）都执行的操作如下"><a href="#一、在两节点（master和node）都执行的操作如下" class="headerlink" title="一、在两节点（master和node）都执行的操作如下"></a>一、在两节点（master和node）都执行的操作如下</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>关闭防火墙</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld   #关闭防火墙</span><br><span class="line">systemctl disable firewalld   #关闭防火墙自启</span><br></pre></td></tr></table></figure>
<h3 id="禁用selinux"><a href="#禁用selinux" class="headerlink" title="禁用selinux"></a>禁用selinux</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 临时禁用</span><br><span class="line">setenforce 0</span><br><span class="line"># 永久禁用 </span><br><span class="line">vi &#x2F;etc&#x2F;selinux&#x2F;config    # 或者修改&#x2F;etc&#x2F;sysconfig&#x2F;selinux</span><br><span class="line">SELINUX&#x3D;disabled   #将该项改为disabled</span><br></pre></td></tr></table></figure>
<h3 id="修改k8s-conf文件"><a href="#修改k8s-conf文件" class="headerlink" title="修改k8s.conf文件"></a>修改k8s.conf文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;  &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables &#x3D; 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables &#x3D; 1</span><br><span class="line">EOF</span><br><span class="line"># read values from all system directories</span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>
<h6 id="注意：如果不修改上面的，后面kubeadm-init时会报net-bridge-bridge-nf-call-ip6tables-not-set-equal-1的错误"><a href="#注意：如果不修改上面的，后面kubeadm-init时会报net-bridge-bridge-nf-call-ip6tables-not-set-equal-1的错误" class="headerlink" title="注意：如果不修改上面的，后面kubeadm init时会报net.bridge.bridge-nf-call-ip6tables not set equal 1的错误"></a>注意：如果不修改上面的，后面kubeadm init时会报net.bridge.bridge-nf-call-ip6tables not set equal 1的错误</h6><h3 id="开启ipv4转发"><a href="#开启ipv4转发" class="headerlink" title="开启ipv4转发"></a>开启ipv4转发</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">#添加如下内容：开启ipv4转发</span><br><span class="line">net.ipv4.ip_forward &#x3D; 1</span><br><span class="line">#刷新参数</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h3 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 临时关闭</span><br><span class="line">swapoff -a</span><br><span class="line">#修改 &#x2F;etc&#x2F;fstab 文件，注释掉 SWAP 的自动挂载（永久关闭swap，重启后生效）</span><br><span class="line"># 注释掉以下字段</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;cl-swap     swap                    swap    defaults        0 0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">free -l   #查看swap是否关闭，即swap分区为0</span><br></pre></td></tr></table></figure>
<p>如图所示：<img src="https://img-blog.csdnimg.cn/20201208202353330.png#pic_center"></p>
<h3 id="安装docker-注意：2020-10-30，kubernets-1-15-1-docker-18-09"><a href="#安装docker-注意：2020-10-30，kubernets-1-15-1-docker-18-09" class="headerlink" title="安装docker(注意：2020-10-30，kubernets 1.15.1, docker 18.09)"></a>安装docker(注意：2020-10-30，kubernets 1.15.1, docker 18.09)</h3><p>#安装epel更新源</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y vim wget epel-release</span><br></pre></td></tr></table></figure>
<h3 id="使用Docker仓库进行安装"><a href="#使用Docker仓库进行安装" class="headerlink" title="使用Docker仓库进行安装"></a>使用Docker仓库进行安装</h3><p>#在新主机上首次安装 Docker Engine-Community 之前，需要设置 Docker 仓库。之后，您可以从仓库安装和更新 Docker。<br>#安装所需的软件包。yum-utils 提供了 yum-config-manager ，并且 device mapper 存储驱动程序需要 device-mapper-persistent-data 和 lvm2。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure>
<p>#使用以下命令设置稳定的仓库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">  --add-repo \</span><br><span class="line">  https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br></pre></td></tr></table></figure>
<h3 id="要安装特定版本的-Docker-Engine-Community，请在存储库中列出可用版本，然后选择并安装："><a href="#要安装特定版本的-Docker-Engine-Community，请在存储库中列出可用版本，然后选择并安装：" class="headerlink" title="要安装特定版本的 Docker Engine-Community，请在存储库中列出可用版本，然后选择并安装："></a>要安装特定版本的 Docker Engine-Community，请在存储库中列出可用版本，然后选择并安装：</h3><p>1、列出并排序您存储库中可用的版本。此示例按版本号（从高到低）对结果进行排序。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r</span><br></pre></td></tr></table></figure>
<p>2、通过其完整的软件包名称安装特定版本，该软件包名称是软件包名称（docker-ce）加上版本字符串（第二列），从第一个冒号（:）一直到第一个连字符，并用连字符（-）分隔。例如：docker-ce-18.09.5</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y docker-ce-18.09.5-3.el7 docker-ce-cli-18.09.5-3.el7 containerd.io</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker</span><br><span class="line">docker version #查看docker版本以及确定docker是否安装好</span><br></pre></td></tr></table></figure>
<h3 id="启动Docker"><a href="#启动Docker" class="headerlink" title="启动Docker"></a>启动Docker</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl status docker #查看docker运行状态</span><br></pre></td></tr></table></figure>
<h3 id="配置Docker-Hub镜像加速器"><a href="#配置Docker-Hub镜像加速器" class="headerlink" title="配置Docker Hub镜像加速器"></a>配置Docker Hub镜像加速器</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#创建docker目录</span><br><span class="line">mkdir -p &#x2F;etc&#x2F;docker</span><br><span class="line">#配置加速，可参考自己在阿里云中的模板，以下来自网络</span><br><span class="line">tee &#x2F;etc&#x2F;docker&#x2F;daemon.json &lt;&lt;-&#39;EOF&#39;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;: [</span><br><span class="line">        &quot;https:&#x2F;&#x2F;1nj0zren.mirror.aliyuncs.com&quot;,</span><br><span class="line">        &quot;https:&#x2F;&#x2F;docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">        &quot;http:&#x2F;&#x2F;f1361db2.m.daocloud.io&quot;,</span><br><span class="line">        &quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">#重启docker</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;docker&#x2F;daemon.json   #查看目录文件是否配置好</span><br></pre></td></tr></table></figure>
<h3 id="安装docker命令补全工具（选择可安装可不安）"><a href="#安装docker命令补全工具（选择可安装可不安）" class="headerlink" title="安装docker命令补全工具（选择可安装可不安）"></a>安装docker命令补全工具（选择可安装可不安）</h3><p>安装完成后，退出用户重新登录一次</p>
<h3 id="设置docker开机自启动"><a href="#设置docker开机自启动" class="headerlink" title="设置docker开机自启动"></a>设置docker开机自启动</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable docker   </span><br></pre></td></tr></table></figure>
<h3 id="Docker至此安装完成"><a href="#Docker至此安装完成" class="headerlink" title="Docker至此安装完成"></a>Docker至此安装完成</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hostnamectl set-hostname master #修改主机名称，切记不能带下划线</span><br></pre></td></tr></table></figure>
<h3 id="安装kubeadm，kubelet，kubectl-指定版本1-15-1"><a href="#安装kubeadm，kubelet，kubectl-指定版本1-15-1" class="headerlink" title="安装kubeadm，kubelet，kubectl(指定版本1.15.1)"></a>安装kubeadm，kubelet，kubectl(指定版本1.15.1)</h3><p>###在各节点安装kubeadm，kubelet，kubectl<br>修改yum安装源</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; &#x2F;etc&#x2F;yum.repos.d&#x2F;kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name&#x3D;Kubernetes</span><br><span class="line">baseurl&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;repos&#x2F;kubernetes-el7-x86_64&#x2F;</span><br><span class="line">enabled&#x3D;1</span><br><span class="line">gpgcheck&#x3D;1</span><br><span class="line">repo_gpgcheck&#x3D;1</span><br><span class="line">gpgkey&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;yum-key.gpg https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>安装软件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y kubelet-1.15.1-0 kubeadm-1.15.1-0 kubectl-1.15.1-0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start kubelet #启动kubelet</span><br><span class="line">systemctl status kubelet  #查看kubelet状态</span><br></pre></td></tr></table></figure>
<p>如果不是running状态</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubelet.service; disabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br><span class="line">   Active: activating (auto-restart) (Result: exit-code) since 六 2020-11-28 11:07:48 CST; 4s ago</span><br><span class="line">     Docs: https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;</span><br><span class="line">  Process: 6515 ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_de&#x3D;exited, status&#x3D;255)</span><br><span class="line"> Main PID: 6515 (code&#x3D;exited, status&#x3D;255)</span><br><span class="line"></span><br><span class="line">11月 28 11:07:48 master systemd[1]: Unit kubelet.service entered failed state.</span><br><span class="line">11月 28 11:07:48 master systemd[1]: kubelet.service failed.</span><br></pre></td></tr></table></figure>
<p>一般2种可能：<br>1，docker info中的Cgroup 和kubelet中的Cgroup 不一致，会导致node上的kubelet启动失败，（大坑），必修两者修改一致，<br>注意：加入daemon.json时必须放到该文件最后，否则重启docker后查看dockers info 没有生效</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi  &#x2F;etc&#x2F;docker&#x2F;daemon.json </span><br><span class="line">#增加下面内容。注意：在&quot;[]&quot;后面加上&quot;,&quot;</span><br><span class="line">#注意要加到最后，不能加到第一行去。否则docker重启没效果</span><br><span class="line">&quot;exec-opts&quot;: [&quot;native.cgroupdriver&#x3D;systemd&quot;]</span><br><span class="line">#修改后，要重启docker ,用</span><br><span class="line">systemctl restart docker</span><br><span class="line">#检查是否修改</span><br><span class="line">docker info |grep Cgroup</span><br></pre></td></tr></table></figure>
<p>修改后应该显示：Cgroup Driver: systemd<br>重启kubelet</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<h2 id="二、在master结点进行初始化"><a href="#二、在master结点进行初始化" class="headerlink" title="二、在master结点进行初始化"></a>二、在master结点进行初始化</h2><p>运行初始化命令，要修改apiserver的IP要是master节点的IP</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubeadm init --kubernetes-version&#x3D;1.15.1 \</span><br><span class="line">--apiserver-advertise-address&#x3D;192.168.41.20 \</span><br><span class="line">--image-repository registry.aliyuncs.com&#x2F;google_containers \</span><br><span class="line">--service-cidr&#x3D;10.1.0.0&#x2F;16 \</span><br><span class="line">--pod-network-cidr&#x3D;10.244.0.0&#x2F;16</span><br></pre></td></tr></table></figure>
<p>参数解释：<br>–kubernetes-version: 用于指定k8s版本；<br>–apiserver-advertise-address：用于指定kube-apiserver监听的ip地址,就是 master本机IP地址。<br>–pod-network-cidr：用于指定Pod的网络范围； 10.244.0.0/16<br>–service-cidr：用于指定SVC的网络范围；<br>–image-repository: 指定阿里云镜像仓库地址<br>这一步很关键，由于kubeadm 默认从官网k8s.grc.io下载所需镜像，国内无法访问，因此需要通过–image-repository指定阿里云镜像仓库地址</p>
<p>初始化过程说明：<br>[preflight] kubeadm 执行初始化前的检查。<br>[kubelet-start] 生成kubelet的配置文件”/var/lib/kubelet/config.yaml”<br>[certificates] 生成相关的各种token和证书<br>[kubeconfig] 生成 KubeConfig 文件，kubelet 需要这个文件与 Master 通信<br>[control-plane] 安装 Master 组件，会从指定的 Registry 下载组件的 Docker 镜像。<br>[bootstraptoken] 生成token记录下来，后边使用kubeadm join往集群中添加节点时会用到<br>[addons] 安装附加组件 kube-proxy 和 kube-dns。 Kubernetes Master 初始化成功，提示如何配置常规用户使用kubectl访问集群。 提示如何安装 Pod 网络。 提示如何注册其他节点到 Cluster。</p>
<p>集群初始化成功后返回如下信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[init] Using Kubernetes version: v1.15.1</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">	[WARNING Hostname]: hostname &quot;master&quot; could not be reached</span><br><span class="line">	[WARNING Hostname]: hostname &quot;master&quot;: lookup master on 114.114.114.114:53: no such host</span><br><span class="line">	[WARNING Service-Kubelet]: kubelet service is not enabled, please run &#39;systemctl enable kubelet.se</span><br><span class="line">[preflight] Pulling images required for setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39;</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;config.yaml&quot;</span><br><span class="line">[kubelet-start] Activating the kubelet service</span><br><span class="line">[certs] Using certificateDir folder &quot;&#x2F;etc&#x2F;kubernetes&#x2F;pki&quot;</span><br><span class="line">[certs] Generating &quot;ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver&quot; certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed for DNS names [master kubernetes kubernetes.default kubernetes.de IPs [10.1.0.1 192.168.41.20]</span><br><span class="line">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd&#x2F;ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd&#x2F;server&quot; certificate and key</span><br><span class="line">[certs] etcd&#x2F;server serving cert is signed for DNS names [master localhost] and IPs [192.168.41.20 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd&#x2F;healthcheck-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd&#x2F;peer&quot; certificate and key</span><br><span class="line">[certs] etcd&#x2F;peer serving cert is signed for DNS names [master localhost] and IPs [192.168.41.20 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;sa&quot; key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder &quot;&#x2F;etc&#x2F;kubernetes&quot;</span><br><span class="line">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</span><br><span class="line">[control-plane] Using manifest folder &quot;&#x2F;etc&#x2F;kubernetes&#x2F;manifests&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span><br><span class="line">[etcd] Creating static Pod manifest for local etcd in &quot;&#x2F;etc&#x2F;kubernetes&#x2F;manifests&quot;</span><br><span class="line">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;&#x2F;etc&#x2F;kubernetes&#x2F;manifests&quot;. This can take up to 4m0s</span><br><span class="line">[kubelet-check] Initial timeout of 40s passed.</span><br><span class="line">[apiclient] All control plane components are healthy after 49.504267 seconds</span><br><span class="line">[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap &quot;kubelet-config-1.15&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span><br><span class="line">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line">[mark-control-plane] Marking the node master as control-plane by adding the label &quot;node-role.kubernetes.io&#x2F;master&#x3D;&#39;&#39;&quot;</span><br><span class="line">[mark-control-plane] Marking the node master as control-plane by adding the taints [node-role.kubernetes.io&#x2F;master:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: cl8ss3.3pujro3n8su6esgt</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span><br><span class="line">[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME&#x2F;.kube</span><br><span class="line">  sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;concepts&#x2F;cluster-administration&#x2F;addons&#x2F;</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.41.20:6443 --token cl8ss3.3pujro3n8su6esgt \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:0472b072c10eca27f42a5477ff7495c160e936c3c96b6287b8fe7c8333dc21aa </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果提升下面错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[WARNING Hostname]: hostname &quot;master&quot; could not be reached</span><br><span class="line">	[WARNING Hostname]: hostname &quot;master&quot;: lookup master on 114.114.114.114:53: no such host</span><br></pre></td></tr></table></figure>
<p>修改hosts文件,所有节点都修改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;hosts</span><br><span class="line">192.168.41.10 node</span><br><span class="line">192.168.41.20 master</span><br></pre></td></tr></table></figure>
<p>注意，此时记下初始化的命令中的该语句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubeadm join 192.168.41.20:6443 --token cl8ss3.3pujro3n8su6esgt \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:0472b072c10eca27f42a5477ff7495c160e936c3c96b6287b8fe7c8333dc21aa </span><br></pre></td></tr></table></figure>
<p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<h3 id="配置kubectl工具"><a href="#配置kubectl工具" class="headerlink" title="配置kubectl工具"></a>配置kubectl工具</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p $HOME&#x2F;.kube</span><br><span class="line">sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</span><br></pre></td></tr></table></figure>
<h4 id="检查master节点"><a href="#检查master节点" class="headerlink" title="检查master节点"></a>检查master节点</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get node </span><br></pre></td></tr></table></figure>
<h4 id="看到noteReady-，是因为没有配置网络"><a href="#看到noteReady-，是因为没有配置网络" class="headerlink" title="看到noteReady ，是因为没有配置网络"></a>看到noteReady ，是因为没有配置网络</h4><p>需要安装Calico或者flannel，以下以calico为例：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir k8s</span><br><span class="line">cd k8s</span><br><span class="line">wget https:&#x2F;&#x2F;docs.projectcalico.org&#x2F;v3.10&#x2F;getting-started&#x2F;kubernetes&#x2F;installation&#x2F;hosted&#x2F;kubernetes-datastore&#x2F;calico-networking&#x2F;1.7&#x2F;calico.yaml</span><br><span class="line"></span><br><span class="line">## 将192.168.0.0&#x2F;16修改ip地址为10.244.0.0&#x2F;16</span><br><span class="line">sed -i &#39;s&#x2F;192.168.0.0&#x2F;10.244.0.0&#x2F;g&#39; calico.yaml</span><br></pre></td></tr></table></figure>
<h3 id="加载Calico"><a href="#加载Calico" class="headerlink" title="加载Calico"></a>加载Calico</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>
<h4 id="或者flannel网络插件（没用过）"><a href="#或者flannel网络插件（没用过）" class="headerlink" title="或者flannel网络插件（没用过）"></a>或者flannel网络插件（没用过）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;coreos&#x2F;flannel&#x2F;master&#x2F;Documentation&#x2F;kube-flannel.yml</span><br></pre></td></tr></table></figure>

<p>默认镜像地址无法访问，sed命令修改为docker hub镜像仓库。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;coreos&#x2F;flannel&#x2F;master&#x2F;Documentation&#x2F;kube-flannel.yml</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-flannel-ds-amd64-2pc95   1&#x2F;1     Running   0          72s</span><br></pre></td></tr></table></figure>
<h3 id="检查master节点的pods和node"><a href="#检查master节点的pods和node" class="headerlink" title="检查master节点的pods和node"></a>检查master节点的pods和node</h3><p>需要等一会，如显示pending,Init:1/3,ContainerCreating,PodInitializing</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get pods -A</span><br><span class="line">NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-cfd7df94d-pnpn5   1&#x2F;1     Running   0          2m25s</span><br><span class="line">kube-system   calico-node-w7m6f                         1&#x2F;1     Running   0          2m25s</span><br><span class="line">kube-system   coredns-bccdc95cf-jfhf5                 1&#x2F;1     Running   0          13m</span><br><span class="line">kube-system   coredns-bccdc95cf-lr98q                1&#x2F;1     Running   0          13m</span><br><span class="line">kube-system   etcd-master                                     1&#x2F;1     Running   0          12m</span><br><span class="line">kube-system   kube-apiserver-master                    1&#x2F;1     Running   0          12m</span><br><span class="line">kube-system   kube-controller-manager-master   1&#x2F;1     Running   0          13m</span><br><span class="line">kube-system   kube-proxy-dqwnk                          1&#x2F;1     Running   0          13m</span><br><span class="line">kube-system   kube-scheduler-master                   1&#x2F;1     Running   0          12m</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES    AGE   VERSION</span><br><span class="line">master   Ready    master   16m   v1.15.1</span><br></pre></td></tr></table></figure>
<p>满足以上情况，说明master结点已就绪</p>
<h2 id="三、加入node节点"><a href="#三、加入node节点" class="headerlink" title="三、加入node节点"></a>三、加入node节点</h2><p>执行上述中master初始化中给出的join语句</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubeadm join 192.168.41.20:6443 --token cl8ss3.3pujro3n8su6esgt \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:0472b072c10eca27f42a5477ff7495c160e936c3c96b6287b8fe7c8333dc21aa</span><br></pre></td></tr></table></figure>
<p>如果忘记了，可以用命令重新生成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
<p>最后，在master节点上看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get pod --all-namespaces -o wide</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE     IP              NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   calico-kube-controllers-cfd7df94d-pnpn5   1&#x2F;1     Running   0          16m     10.244.219.65   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   calico-node-68mrj                         0&#x2F;1     Running   0          3m51s   192.168.41.10   node     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   calico-node-w7m6f                         1&#x2F;1     Running   0          16m     192.168.41.20   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-bccdc95cf-jfhf5                   1&#x2F;1     Running   1          27m     10.244.219.67   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-bccdc95cf-lr98q                   1&#x2F;1     Running   1          27m     10.244.219.66   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-master                               1&#x2F;1     Running   0          26m     192.168.41.20   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-master                     1&#x2F;1     Running   0          26m     192.168.41.20   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-master            1&#x2F;1     Running   1          26m     192.168.41.20   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-dqwnk                          1&#x2F;1     Running   0          27m     192.168.41.20   master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-h2cbf                          1&#x2F;1     Running   0          3m51s   192.168.41.10   node     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-master                     1&#x2F;1     Running   1          26m     192.168.41.20   master   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>等待全部为running状态</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES    AGE    VERSION</span><br><span class="line">master   Ready    master   27m    v1.15.1</span><br><span class="line">node     Ready    &lt;none&gt;   4m1s   v1.15.1</span><br></pre></td></tr></table></figure>
<h3 id="至此，简单的k8s集群安装完毕。"><a href="#至此，简单的k8s集群安装完毕。" class="headerlink" title="至此，简单的k8s集群安装完毕。"></a>至此，简单的k8s集群安装完毕。</h3><p>如果出现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在所有节点重启kubelet试一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart kubelet.service</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>访问地址：<a href="http://NodeIP:Port">http://NodeIP:Port</a>  </p>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://img-blog.csdnimg.cn/20201208203141264.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/Radiant-zi/2020/12/01/xampp%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80phpmyadmin/"><img class="next-cover" src="https://img-blog.csdnimg.cn/20201202230603801.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center" onerror="onerror=null;src='/Radiant-zi/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">xampp无法打开phpmyadmin问题</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/Radiant-zi/img/avatar.gif" onerror="this.onerror=null;this.src='/Radiant-zi/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">jiewen</div><div class="author-info__description">杏花春雨江南</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/Radiant-zi/archives/"><div class="headline">文章</div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/Radiant-zi/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Radiant-zi"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Radiant-zi" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1217634794@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1217634794&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">系统环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E5%8F%82%E7%85%A7%E6%AD%A4%E5%8D%9A%E5%AE%A2%E7%9A%84%E9%94%99%E8%AF%AFhttps-blog-csdn-net-nklinsirui-article-details-80583971"><span class="toc-number">2.</span> <span class="toc-text">先参照此博客的错误https:&#x2F;&#x2F;blog.csdn.net&#x2F;nklinsirui&#x2F;article&#x2F;details&#x2F;80583971</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9C%A8%E4%B8%A4%E8%8A%82%E7%82%B9%EF%BC%88master%E5%92%8Cnode%EF%BC%89%E9%83%BD%E6%89%A7%E8%A1%8C%E7%9A%84%E6%93%8D%E4%BD%9C%E5%A6%82%E4%B8%8B"><span class="toc-number"></span> <span class="toc-text">一、在两节点（master和node）都执行的操作如下</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E7%94%A8selinux"><span class="toc-number">2.</span> <span class="toc-text">禁用selinux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9k8s-conf%E6%96%87%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">修改k8s.conf文件</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E5%A6%82%E6%9E%9C%E4%B8%8D%E4%BF%AE%E6%94%B9%E4%B8%8A%E9%9D%A2%E7%9A%84%EF%BC%8C%E5%90%8E%E9%9D%A2kubeadm-init%E6%97%B6%E4%BC%9A%E6%8A%A5net-bridge-bridge-nf-call-ip6tables-not-set-equal-1%E7%9A%84%E9%94%99%E8%AF%AF"><span class="toc-number">3.0.0.1.</span> <span class="toc-text">注意：如果不修改上面的，后面kubeadm init时会报net.bridge.bridge-nf-call-ip6tables not set equal 1的错误</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AFipv4%E8%BD%AC%E5%8F%91"><span class="toc-number">4.</span> <span class="toc-text">开启ipv4转发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%ADswap"><span class="toc-number">5.</span> <span class="toc-text">关闭swap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker-%E6%B3%A8%E6%84%8F%EF%BC%9A2020-10-30%EF%BC%8Ckubernets-1-15-1-docker-18-09"><span class="toc-number">6.</span> <span class="toc-text">安装docker(注意：2020-10-30，kubernets 1.15.1, docker 18.09)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Docker%E4%BB%93%E5%BA%93%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85"><span class="toc-number">7.</span> <span class="toc-text">使用Docker仓库进行安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%81%E5%AE%89%E8%A3%85%E7%89%B9%E5%AE%9A%E7%89%88%E6%9C%AC%E7%9A%84-Docker-Engine-Community%EF%BC%8C%E8%AF%B7%E5%9C%A8%E5%AD%98%E5%82%A8%E5%BA%93%E4%B8%AD%E5%88%97%E5%87%BA%E5%8F%AF%E7%94%A8%E7%89%88%E6%9C%AC%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%89%E6%8B%A9%E5%B9%B6%E5%AE%89%E8%A3%85%EF%BC%9A"><span class="toc-number">8.</span> <span class="toc-text">要安装特定版本的 Docker Engine-Community，请在存储库中列出可用版本，然后选择并安装：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Docker"><span class="toc-number">9.</span> <span class="toc-text">启动Docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEDocker-Hub%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E5%99%A8"><span class="toc-number">10.</span> <span class="toc-text">配置Docker Hub镜像加速器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker%E5%91%BD%E4%BB%A4%E8%A1%A5%E5%85%A8%E5%B7%A5%E5%85%B7%EF%BC%88%E9%80%89%E6%8B%A9%E5%8F%AF%E5%AE%89%E8%A3%85%E5%8F%AF%E4%B8%8D%E5%AE%89%EF%BC%89"><span class="toc-number">11.</span> <span class="toc-text">安装docker命令补全工具（选择可安装可不安）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEdocker%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="toc-number">12.</span> <span class="toc-text">设置docker开机自启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E8%87%B3%E6%AD%A4%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90"><span class="toc-number">13.</span> <span class="toc-text">Docker至此安装完成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kubeadm%EF%BC%8Ckubelet%EF%BC%8Ckubectl-%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC1-15-1"><span class="toc-number">14.</span> <span class="toc-text">安装kubeadm，kubelet，kubectl(指定版本1.15.1)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9C%A8master%E7%BB%93%E7%82%B9%E8%BF%9B%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number"></span> <span class="toc-text">二、在master结点进行初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEkubectl%E5%B7%A5%E5%85%B7"><span class="toc-number">1.</span> <span class="toc-text">配置kubectl工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5master%E8%8A%82%E7%82%B9"><span class="toc-number">1.1.</span> <span class="toc-text">检查master节点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9C%8B%E5%88%B0noteReady-%EF%BC%8C%E6%98%AF%E5%9B%A0%E4%B8%BA%E6%B2%A1%E6%9C%89%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C"><span class="toc-number">1.2.</span> <span class="toc-text">看到noteReady ，是因为没有配置网络</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BDCalico"><span class="toc-number">2.</span> <span class="toc-text">加载Calico</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%96%E8%80%85flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%EF%BC%88%E6%B2%A1%E7%94%A8%E8%BF%87%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">或者flannel网络插件（没用过）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5master%E8%8A%82%E7%82%B9%E7%9A%84pods%E5%92%8Cnode"><span class="toc-number">3.</span> <span class="toc-text">检查master节点的pods和node</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%8A%A0%E5%85%A5node%E8%8A%82%E7%82%B9"><span class="toc-number"></span> <span class="toc-text">三、加入node节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%B3%E6%AD%A4%EF%BC%8C%E7%AE%80%E5%8D%95%E7%9A%84k8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E5%AE%8C%E6%AF%95%E3%80%82"><span class="toc-number">1.</span> <span class="toc-text">至此，简单的k8s集群安装完毕。</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Radiant-zi/2020/12/08/k8s%E7%9A%84%E5%AE%89%E8%A3%85/" title="k8s安装"><img src="https://img-blog.csdnimg.cn/20201208203141264.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center" onerror="this.onerror=null;this.src='/Radiant-zi/img/404.jpg'" alt="k8s安装"/></a><div class="content"><a class="title" href="/Radiant-zi/2020/12/08/k8s%E7%9A%84%E5%AE%89%E8%A3%85/" title="k8s安装">k8s安装</a><time datetime="2020-12-08T12:32:10.000Z" title="发表于 2020-12-08 20:32:10">2020-12-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Radiant-zi/2020/12/01/xampp%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80phpmyadmin/" title="xampp无法打开phpmyadmin问题"><img src="https://img-blog.csdnimg.cn/20201202230603801.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center" onerror="this.onerror=null;this.src='/Radiant-zi/img/404.jpg'" alt="xampp无法打开phpmyadmin问题"/></a><div class="content"><a class="title" href="/Radiant-zi/2020/12/01/xampp%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80phpmyadmin/" title="xampp无法打开phpmyadmin问题">xampp无法打开phpmyadmin问题</a><time datetime="2020-12-01T04:29:59.000Z" title="发表于 2020-12-01 12:29:59">2020-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Radiant-zi/2020/12/01/%E5%BC%95%E5%85%A5css,js%E6%96%87%E4%BB%B6%E9%94%99%E8%AF%AF/" title="无法引入css，js文件"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/Radiant-zi/img/404.jpg'" alt="无法引入css，js文件"/></a><div class="content"><a class="title" href="/Radiant-zi/2020/12/01/%E5%BC%95%E5%85%A5css,js%E6%96%87%E4%BB%B6%E9%94%99%E8%AF%AF/" title="无法引入css，js文件">无法引入css，js文件</a><time datetime="2020-12-01T01:25:00.000Z" title="发表于 2020-12-01 09:25:00">2020-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Radiant-zi/2020/11/20/linux/" title="centos配置代理防火墙"><img src="https://img-blog.csdnimg.cn/20201201231609811.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center" onerror="this.onerror=null;this.src='/Radiant-zi/img/404.jpg'" alt="centos配置代理防火墙"/></a><div class="content"><a class="title" href="/Radiant-zi/2020/11/20/linux/" title="centos配置代理防火墙">centos配置代理防火墙</a><time datetime="2020-11-20T04:29:59.000Z" title="发表于 2020-11-20 12:29:59">2020-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Radiant-zi/2020/11/17/%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/" title="hexo-尝试使用（部署）"><img src="https://img-blog.csdnimg.cn/20201202230659584.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1Mjc4Njc0,size_16,color_FFFFFF,t_70#pic_center" onerror="this.onerror=null;this.src='/Radiant-zi/img/404.jpg'" alt="hexo-尝试使用（部署）"/></a><div class="content"><a class="title" href="/Radiant-zi/2020/11/17/%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/" title="hexo-尝试使用（部署）">hexo-尝试使用（部署）</a><time datetime="2020-11-17T09:27:29.000Z" title="发表于 2020-11-17 17:27:29">2020-11-17</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By jiewen</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/Radiant-zi/js/utils.js"></script><script src="/Radiant-zi/js/main.js"></script><script src="/Radiant-zi/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script type="text/javascript" src="./js/xkTool.js"></script><script type="text/javascript" src="./js/myjs.js"></script></div></body></html>